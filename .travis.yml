dist: xenial
language: bash

# Filter to only run this pipeline when it involves actions against the master branch
branches:
  only:
    - master
    - staging
    - development
    - sonarQube
    - testing
    - test
    - "/^v\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/"

# Export variables
env:
  # This environment variable tells Terraform not to prompt for input. This is
  # not required, but if we make a mistake, the Travis builder will hang waiting
  # for user input, tieing up unnecessary resources.
#  - TF_INPUT=false
  - tf_version=0.14.8 tf_init_cli_options="-input=false" tf_validation_cli_options="" tf_plan_cli_options="-lock=false -input=false" tf_apply_cli_options="-auto-approve -input=false -lock=false"

before_install: # Download and install Terraform for us on the container (v0.12.25)
  - wget https://releases.hashicorp.com/terraform/0.14.8/terraform_0.14.8_linux_amd64.zip
  - unzip terraform_0.14.8_linux_amd64.zip
  - sudo mv terraform /usr/local/bin/
  - rm terraform_0.14.8_linux_amd64.zip

jobs:
  include:
    - stage: terraform plan # When a Pull Request is created - Validate our plan
      if: type IN (pull_request)
      script:
        - terraform init
        - terraform plan -var-file=env\dev\vars.tfvars -out build.plan

    - stage: terraform apply # Merge our PR - Deploy it!
      if: type IN (push) and branch = master
      script:
        - terraform init
        - terraform plan -var-file=env\dev\vars.tfvars -out build.plan
        - terraform apply build.plan


